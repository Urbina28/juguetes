<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Venta del Corte</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="VentaCorte">
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --success: #10b981; --danger: #ef4444; --dark: #1e293b; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f1f5f9; margin: 0; padding: env(safe-area-inset-top) 10px 20px 10px;
            display: flex; flex-direction: column; align-items: center; 
        }
        .container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 450px; box-sizing: border-box; }
        
        #reader { width: 100%; border-radius: 15px; overflow: hidden; background: #000; min-height: 200px; border: 3px solid var(--primary); }
        
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 15px 0; }
        .stat-card { padding: 12px 5px; border-radius: 12px; text-align: center; color: white; font-weight: bold; }
        .bg-blue { background: var(--primary); } .bg-orange { background: #f59e0b; } .bg-green { background: var(--success); }
        .stat-card small { font-size: 0.65rem; display: block; opacity: 0.9; text-transform: uppercase; }
        .stat-card strong { font-size: 0.9rem; }

        .form-group { margin-bottom: 10px; }
        input { 
            width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; 
            box-sizing: border-box; font-size: 16px; -webkit-appearance: none; 
        }
        input:focus { border-color: var(--primary); outline: none; }
        
        button { 
            width: 100%; padding: 15px; border: none; border-radius: 12px; cursor: pointer; 
            font-size: 16px; font-weight: bold; transition: 0.2s; -webkit-tap-highlight-color: transparent;
        }
        .btn-add { background: var(--dark); color: white; margin-top: 5px; }
        .btn-camera { background: #e2e8f0; color: var(--dark); margin-bottom: 15px; font-size: 14px; }
        .btn-camera.active { background: var(--danger); color: white; }
        .btn-download { background: var(--success); color: white; margin-top: 15px; }
        .btn-panic { background: transparent; color: var(--danger); margin-top: 20px; font-size: 12px; text-decoration: underline; }

        .tabla-container { width: 100%; margin-top: 20px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; }
        th { background: #f8fafc; padding: 12px 8px; text-align: left; color: #64748b; }
        td { padding: 12px 8px; border-top: 1px solid #e2e8f0; }
        .ganancia-plus { color: var(--success); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color: var(--dark); margin-bottom: 15px; font-size: 1.2rem;">Ventas Katy Urbina</h2>

    <div id="reader"></div>
    <button id="btnToggleCam" class="btn-camera" onclick="toggleCam()">üì∑ ENCENDER SCANNER</button>

    <div class="dashboard">
        <div class="stat-card bg-blue"><small>Ventas</small><strong id="totalVenta">$0</strong></div>
        <div class="stat-card bg-orange"><small>Inversi√≥n</small><strong id="totalInversion">$0</strong></div>
        <div class="stat-card bg-green"><small>Ganancia</small><strong id="totalGanancia">$0</strong></div>
    </div>

    <div class="form-group">
        <input type="text" id="nombre" placeholder="Nombre del producto">
    </div>
    <div style="display: flex; gap: 8px;">
        <input type="text" id="codigo" placeholder="C√≥digo" readonly style="background: #f1f5f9; flex: 1.2;">
        <input type="number" id="inversion" placeholder="Costo" style="flex: 0.9;">
        <input type="number" id="venta" placeholder="Venta" style="flex: 0.9;">
    </div>

    <button class="btn-add" onclick="registrarVenta()">REGISTRAR VENTA</button>
    
    <div class="tabla-container">
        <table id="tablaVentas">
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Producto</th>
                    <th>Venta</th>
                    <th>Gan.</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <button class="btn-download" onclick="descargarExcel()">‚¨áÔ∏è GUARDAR REPORTE (CSV)</button>
    <button class="btn-panic" onclick="botonPanico()">Borrar sesi√≥n actual</button>
</div>

<script>
    let registroVentas = [];
    let totales = { inversion: 0, venta: 0, ganancia: 0 };
    let html5QrCode = null;
    let isCamOn = false;

    async function toggleCam() {
        const btn = document.getElementById('btnToggleCam');
        if (!isCamOn) {
            html5QrCode = new Html5Qrcode("reader");
            try {
                await html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 15, qrbox: { width: 250, height: 150 } },
                    (decodedText) => {
                        document.getElementById('codigo').value = decodedText;
                        if (navigator.vibrate) navigator.vibrate(70);
                        document.getElementById('nombre').focus();
                    }
                );
                isCamOn = true;
                btn.innerText = "‚ùå APAGAR SCANNER";
                btn.classList.add("active");
            } catch (err) { alert("C√°mara no disponible"); }
        } else {
            await html5QrCode.stop();
            isCamOn = false;
            btn.innerText = "üì∑ ENCENDER SCANNER";
            btn.classList.remove("active");
        }
    }

    function registrarVenta() {
        const cod = document.getElementById('codigo').value;
        const nom = document.getElementById('nombre').value || "Sin nombre";
        const inv = parseFloat(document.getElementById('inversion').value) || 0;
        const vta = parseFloat(document.getElementById('venta').value) || 0;
        const hora = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        if (!cod && nom === "Sin nombre") return;

        const gan = vta - inv;
        const nuevaVenta = { hora, nom, cod, inv, vta, gan };
        
        registroVentas.push(nuevaVenta);
        totales.inversion += inv;
        totales.venta += vta;
        totales.ganancia += gan;

        actualizarUI(nuevaVenta);
        limpiar();
    }

    function actualizarUI(v) {
        document.getElementById('totalInversion').innerText = "$" + totales.inversion.toFixed(2);
        document.getElementById('totalVenta').innerText = "$" + totales.venta.toFixed(2);
        document.getElementById('totalGanancia').innerText = "$" + totales.ganancia.toFixed(2);
        
        const tabla = document.getElementById('tablaVentas').getElementsByTagName('tbody')[0];
        const fila = tabla.insertRow(0);
        fila.innerHTML = `<td>${v.hora}</td><td>${v.nom}</td><td>$${v.vta}</td><td class="ganancia-plus">+$${v.gan}</td>`;
    }

    function limpiar() {
        document.getElementById('codigo').value = "";
        document.getElementById('nombre').value = "";
        document.getElementById('inversion').value = "";
        document.getElementById('venta').value = "";
    }

    function descargarExcel() {
        if (registroVentas.length === 0) return;
        let csvContent = "data:text/csv;charset=utf-8,Hora,Producto,Codigo,Inversion,Venta,Ganancia\n";
        registroVentas.forEach(v => { csvContent += `${v.hora},${v.nom},${v.cod},${v.inv},${v.vta},${v.gan}\n`; });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "corte_caja.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function botonPanico() {
        if(confirm("¬øBorrar todo?")) location.reload();
    }
</script>

</body>
</html>
