<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gael Toys POS</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gael Toys">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3082/3082060.png">
    <meta name="theme-color" content="#011627">

    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        :root {
            --primary: #4361ee; --success: #2ec4b6; --danger: #e71d36;
            --warning: #ff9f1c; --dark: #011627; --light: #f8f9fa; --white: #ffffff;
        }

        * { user-select: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto;
            background: var(--dark); margin: 0; color: var(--white); 
            height: 100vh; overflow: hidden;
        }
        
        .app-container { 
            height: 100vh; display: flex; flex-direction: column; 
            padding: 20px; padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            justify-content: space-between;
        }

        h2 { text-align: center; font-weight: 300; letter-spacing: 3px; margin: 10px 0; }

        #reader { 
            width: 100%; border-radius: 30px; overflow: hidden; 
            background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.1);
        }

        /* BOT√ìN DE CANCELAR C√ÅMARA */
        #btn-cancelar-camara {
            display: none; background: var(--danger); color: white;
            border: none; padding: 12px; border-radius: 15px;
            margin-top: 10px; width: 100%; font-weight: bold;
        }

        .main-dash { 
            background: rgba(255,255,255,0.07); border-radius: 25px; 
            padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
        }
        .dash-item { text-align: center; }
        .dash-item span { display: block; font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .dash-item b { font-size: 22px; color: var(--success); }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-big { 
            padding: 25px 10px; border: none; border-radius: 22px; 
            font-size: 16px; font-weight: bold; color: white;
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        }
        .btn-recibir { background: var(--primary); }
        .btn-vender { background: var(--danger); }

        .nav-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn-nav { 
            background: #1e293b; padding: 18px; border-radius: 18px; 
            border: 1px solid #334155; color: white; font-size: 13px; font-weight: 600;
        }

        .view-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--light); color: var(--dark); z-index: 100; 
            padding: 25px; overflow-y: auto; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .header-panel { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-cerrar { background: var(--dark); color: white; border: none; padding: 10px 20px; border-radius: 12px; font-weight: bold; }

        .search-bar { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #ddd; margin-bottom: 20px; font-size: 16px; outline: none; }

        .card { 
            background: white; border-radius: 20px; padding: 15px; 
            margin-bottom: 12px; display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
        }
        .qty-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 14px; }
        .stock-ok { background: var(--primary); }
        .stock-low { background: var(--warning); animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .info-txt b { font-size: 15px; display: block; color: var(--dark); }
        .info-txt small { color: var(--gray); font-size: 11px; }
        .price-txt { font-weight: bold; color: var(--primary); font-size: 16px; }
    </style>
</head>
<body>

<div class="app-container">
    <h2> üß∏ MUNDO DE SONRISAS üß∏</h2>

    <div id="reader"></div>
    <button id="btn-cancelar-camara" onclick="detenerEscaneo()">‚ùå CANCELAR ESCANEO</button>
    <div id="status" style="text-align: center; font-size: 12px; color: var(--success); margin: 5px 0;">SISTEMA ACTIVO</div>

    <div class="main-dash">
        <div class="dash-item"><span>üí∞ EN CAJA</span><b id="dash-caja">$0</b></div>
        <div class="dash-item"><span>üì¶ STOCK</span><b id="dash-stock">0</b></div>
    </div>

    <div class="action-grid">
        <button class="btn-big btn-recibir" onclick="iniciarEscaneo('agregar')">üì• RECIBIR</button>
        <button class="btn-big btn-vender" onclick="iniciarEscaneo('vender')">üì§ VENDER</button>
    </div>

    <div class="nav-menu">
        <button class="btn-nav" onclick="abrirPanel('panel-inventario')">üì¶ INVENTARIO</button>
        <button class="btn-nav" onclick="abrirPanel('panel-ventas')">üìã VENTAS</button>
    </div>

    <button onclick="reinicioMaestro()" style="background:none; border:none; color:#334155; font-size:10px; width:100%;">REINICIAR BASE DE DATOS</button>
</div>

<div id="panel-inventario" class="view-panel">
    <div class="header-panel">
        <h3 style="margin:0">üì¶ Inventario</h3>
        <button class="btn-cerrar" onclick="cerrarPanel('panel-inventario')">VOLVER</button>
    </div>
    <input type="text" id="buscador" class="search-bar" placeholder="üîç Buscar juguete..." onkeyup="filtrarLista()">
    <div id="lista-inventario"></div>
</div>

<div id="panel-ventas" class="view-panel">
    <div class="header-panel">
        <h3 style="margin:0">üìã Ventas de Hoy</h3>
        <button class="btn-cerrar" onclick="cerrarPanel('panel-ventas')">VOLVER</button>
    </div>
    <div id="lista-ventas"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue, push, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCI85dhteJ5Z4Wgb2A0pes0RI-KdaTAQlM",
        authDomain: "miinventariojuguetes.firebaseapp.com",
        databaseURL: "https://miinventariojuguetes-default-rtdb.firebaseio.com/",
        projectId: "miinventariojuguetes",
        storageBucket: "miinventariojuguetes.firebasestorage.app",
        messagingSenderId: "872070944528",
        appId: "1:872070944528:web:aeb9deab706b6de0dcb795",
        measurementId: "G-2SG32BF2G0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const scanner = new Html5Qrcode("reader");

    window.abrirPanel = (id) => document.getElementById(id).style.display = 'block';
    window.cerrarPanel = (id) => document.getElementById(id).style.display = 'none';

    window.iniciarEscaneo = (modo) => {
        document.getElementById('status').innerText = "üì∑ ESCANEANDO...";
        document.getElementById('btn-cancelar-camara').style.display = 'block';
        scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (codigo) => {
            detenerEscaneo();
            procesar(codigo, modo);
        });
    };

    window.detenerEscaneo = () => {
        scanner.stop().then(() => {
            document.getElementById('btn-cancelar-camara').style.display = 'none';
            document.getElementById('status').innerText = "SISTEMA ACTIVO";
        }).catch(() => {});
    };

    async function procesar(codigo, modo) {
        const refProd = ref(db, 'juguetes/' + codigo);
        const snap = await get(refProd);

        if (modo === 'agregar') {
            if (snap.exists()) {
                const actual = snap.val();
                const cant = prompt(`Sumar a "${actual.nombre}":`, "1");
                if (cant) update(refProd, { existencia: (parseInt(actual.existencia) || 0) + parseInt(cant) });
            } else {
                const nombre = prompt("Nombre del juguete:");
                const precio = prompt("Precio de venta:");
                const cant = prompt("¬øCu√°ntos recibes?", "1");
                if (nombre) set(refProd, { nombre, precio: parseFloat(precio) || 0, existencia: parseInt(cant) || 1, id: codigo });
            }
        } else {
            if (snap.exists()) {
                const d = snap.val();
                if (confirm(`¬øVender ${d.nombre}?`)) {
                    push(ref(db, 'ventas/'), { 
                        nombre: d.nombre, precio: d.precio, hora: new Date().toLocaleTimeString() 
                    });
                    if (d.existencia > 1) update(refProd, { existencia: d.existencia - 1 });
                    else remove(refProd);
                }
            } else alert("No est√° en el sistema.");
        }
    }

    onValue(ref(db, 'juguetes/'), (snap) => {
        const list = document.getElementById('lista-inventario');
        list.innerHTML = "";
        let stockTotal = 0;
        snap.forEach(h => {
            const p = h.val();
            const ex = parseInt(p.existencia) || 0;
            stockTotal += ex;
            list.innerHTML += `
                <div class="card" data-nombre="${p.nombre.toLowerCase()}">
                    <div class="info-txt"><b>${p.nombre}</b><small>ID: ${p.id}</small></div>
                    <div style="display:flex; align-items:center; gap:15px">
                        <span class="price-txt">$${p.precio || 0}</span>
                        <div class="qty-circle ${ex <= 2 ? 'stock-low' : 'stock-ok'}">${ex}</div>
                    </div>
                </div>`;
        });
        document.getElementById('dash-stock').innerText = isNaN(stockTotal) ? 0 : stockTotal;
    });

    onValue(ref(db, 'ventas/'), (snap) => {
        const list = document.getElementById('lista-ventas');
        list.innerHTML = "";
        let caja = 0;
        snap.forEach(h => {
            const v = h.val();
            const precioVenta = parseFloat(v.precio) || 0;
            const horaVenta = v.hora || "Sin hora"; // Filtro para evitar el "undefined"
            caja += precioVenta;
            list.innerHTML = `
                <div class="card">
                    <div class="info-txt"><b>${v.nombre}</b><small>üïí ${horaVenta}</small></div>
                    <b style="color:var(--success)">$${precioVenta}</b>
                </div>` + list.innerHTML;
        });
        document.getElementById('dash-caja').innerText = "$" + caja;
    });

    window.filtrarLista = () => {
        const query = document.getElementById('buscador').value.toLowerCase();
        document.querySelectorAll('#lista-inventario .card').forEach(c => {
            c.style.display = c.getAttribute('data-nombre').includes(query) ? 'flex' : 'none';
        });
    };

    window.reinicioMaestro = () => { 
        if(prompt("Clave:") === "Gael2025") {
            if(confirm("¬øBORRAR TODO?")) set(ref(db, '/'), null);
        }
    };
</script>
</body>
</html>
